<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>BookingSync API documentation</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/stylesheets/application.css">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
    <link rel="stylesheet" href="/highlight.css">
    <script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="/assets/javascripts/application.js"></script>

    <!-- you don't need to keep this, but it's cool for stats! -->
    <meta name="generator" content="nanoc 3.8.0">
  </head>
  <body class="flex-col">
    <div class="page-wrapper flex-1 flex-col">
      <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle sidebar-toggle collapsed" data-toggle="collapse" data-target="#navigation" aria-expanded="false">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">
              <img alt="BookingSync" src="/images/bookingsync.svg">
              <span>Developers</span>
            </a>
          </div>

          <div class="collapse navbar-collapse" id="navigation">
            <ul class="nav navbar-nav navbar-right">
              <li class="active">
                <a href="/guides/">Guides</a>
              </li>
              <li class="">
                <a href="https://demo.platforms.bookingsync.com/api-docs/index.html" target="_blank">API Reference</a>
              </li>
              <li><a href="https://www.smily.com" target="_blank">Smily.com</a></li>
              <li><a href="https://github.com/BookingSync/channel-api-docs" target="_blank"><i class="fa fa-github fa-fw fa-2x"></i></a></li>
            </ul>
          </div>
        </div>
      </nav>

<div class="container content">
  <div class="row">
    <div class="col-md-3 col-md-push-9">
      <div class="panel panel-default">
        <div class="list-group">
          <a class="list-group-item" href="/guides/api-overview">API overview</a>
          <a class="list-group-item" href="/guides/getting-started">Getting Started</a>
          <a class="list-group-item" href="/guides/accounts-synchronization">Accounts synchronization</a>
          <a class="list-group-item" href="/guides/rentals-synchronization">Rentals synchronization</a>
          <a class="list-group-item" href="/guides/create-a-booking-payments-on-partner-side">Create a booking (payments on partner side)</a>
          <a class="list-group-item" href="/guides/create-a-booking-with-smily-payment-gateway">Create a booking (payments on our side)</a>
          <a class="list-group-item" href="/guides/booking-cancelation">Booking cancelation</a>
        </div>
      </div>
    </div>
    <div class="col-md-9 col-md-pull-3">
      <div class="panel panel-default">
        <div class="panel-body guide-body">
          <h2 id="rentals-synchronization">Rentals synchronization</h2>

<ol id="markdown-toc">
  <li><a href="#preface" id="markdown-toc-preface">Preface</a></li>
  <li><a href="#getting-basic-rental-information" id="markdown-toc-getting-basic-rental-information">Getting Basic Rental Information</a></li>
  <li><a href="#code-example-in-ruby" id="markdown-toc-code-example-in-ruby">Code Example in Ruby</a></li>
  <li><a href="#fetching-rental-availabilities" id="markdown-toc-fetching-rental-availabilities">Fetching Rental Availabilities</a></li>
  <li><a href="#understanding-availabilities" id="markdown-toc-understanding-availabilities">Understanding availabilities</a></li>
  <li><a href="#fetching-rental-prices" id="markdown-toc-fetching-rental-prices">Fetching Rental Prices</a></li>
  <li><a href="#filtering-rentals-by-price" id="markdown-toc-filtering-rentals-by-price">Filtering Rentals by Price</a></li>
</ol>

<h3 id="preface">Preface</h3>

<p>After successfully onboarding accounts, you can initiate the process to import their rentals into your system.</p>

<h3 id="getting-basic-rental-information">Getting Basic Rental Information</h3>

<p>For detailed specifications and endpoint details, refer to the <a href="https://demo.platforms.bookingsync.com/api-docs/index.html">Swagger documentation</a></p>

<blockquote>
  <p>Recommendation: We advise refreshing rental base information once a day</p>
</blockquote>

<h3 id="code-example-in-ruby">Code Example in Ruby</h3>

<pre><code class="language-ruby"><span class="n">token</span> <span class="o">=</span> <span class="s2">"&lt;YOUR_TOKEN&gt;"</span>
<span class="n">api_url</span> <span class="o">=</span> <span class="s2">"&lt;API_URL&gt;"</span>
<span class="n">media_type</span> <span class="o">=</span> <span class="s2">"application/vnd.api+json"</span>
<span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"User-Agent"</span> <span class="o">=&gt;</span> <span class="s2">"Api client"</span><span class="p">,</span>
    <span class="s2">"Accept"</span> <span class="o">=&gt;</span> <span class="n">media_type</span><span class="p">,</span>
    <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="n">media_type</span><span class="p">,</span>
    <span class="s2">"Authorization"</span> <span class="o">=&gt;</span> <span class="s2">"Bearer </span><span class="si">#{</span><span class="n">token</span><span class="si">}</span><span class="s2">"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="no">Account</span><span class="o">.</span><span class="n">approved</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">account</span><span class="o">|</span>
  <span class="n">page_number</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="k">while</span> <span class="kp">true</span> <span class="k">do</span>
    <span class="n">request</span> <span class="o">=</span> <span class="no">Excon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">URI</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="s2">"/api/ota/v1/rentals?page[number]=</span><span class="si">#{</span><span class="n">page_number</span><span class="si">}</span><span class="s2">&amp;page[size]=50&amp;filter[account-id]=</span><span class="si">#{</span><span class="n">account</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">request</span><span class="p">({</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:get</span> <span class="p">})</span>
    <span class="n">json</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
    <span class="n">json</span><span class="o">[</span><span class="s2">"data"</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">rental</span><span class="o">|</span>
      <span class="c1"># Import rental</span>
      <span class="n">import_rental</span><span class="p">(</span><span class="n">rental</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">break</span> <span class="k">if</span> <span class="n">page_number</span> <span class="o">&gt;=</span> <span class="n">json</span><span class="o">[</span><span class="s2">"meta"</span><span class="o">][</span><span class="s2">"pagination"</span><span class="o">][</span><span class="s2">"pages"</span><span class="o">].</span><span class="n">to_i</span>
    <span class="n">page_number</span><span class="o">++</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>

<h3 id="fetching-rental-availabilities">Fetching Rental Availabilities</h3>

<p>Availability is a just a rental field (see <a href="https://demo.platforms.bookingsync.com/api-docs/index.html">Rental Schema</a>). But it makes sense to sync availabilities more often than other information.</p>

<blockquote>
  <p>Recommendation: We suggest refreshing rental availabilities every hour.</p>
</blockquote>

<p>To optimize the retrieval process, it’s recommended to use the fields parameter when fetching rental data. By specifying <code>fields[rentals]=availability</code>, you can streamline the API response to include only the necessary availability information, improving efficiency.</p>

<!-- TODO: choose approach 1 or approach 2 -->

<!-- Approach 1: Fetch batches. No beautiful, but more effective -->
<pre><code class="language-ruby"><span class="n">token</span> <span class="o">=</span> <span class="s2">"&lt;YOUR_TOKEN&gt;"</span>
<span class="n">api_url</span> <span class="o">=</span> <span class="s2">"&lt;API_URL&gt;"</span>
<span class="n">media_type</span> <span class="o">=</span> <span class="s2">"application/vnd.api+json"</span>
<span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"User-Agent"</span> <span class="o">=&gt;</span> <span class="s2">"Api client"</span><span class="p">,</span>
    <span class="s2">"Accept"</span> <span class="o">=&gt;</span> <span class="n">media_type</span><span class="p">,</span>
    <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="n">media_type</span><span class="p">,</span>
    <span class="s2">"Authorization"</span> <span class="o">=&gt;</span> <span class="s2">"Bearer </span><span class="si">#{</span><span class="n">token</span><span class="si">}</span><span class="s2">"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="no">Account</span><span class="o">.</span><span class="n">approved</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">account</span><span class="o">|</span>
  <span class="n">account_rentals_ids</span> <span class="o">=</span> <span class="no">Rental</span><span class="o">.</span><span class="n">for_account</span><span class="p">(</span><span class="n">account</span><span class="p">)</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
  <span class="n">page_number</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="k">while</span> <span class="kp">true</span> <span class="k">do</span>
    <span class="n">request</span> <span class="o">=</span> <span class="no">Excon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">URI</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="s2">"/api/ota/v1/rentals?page[number]=</span><span class="si">#{</span><span class="n">page_number</span><span class="si">}</span><span class="s2">&amp;page[size]=50&amp;filter[account-id]=</span><span class="si">#{</span><span class="n">account</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&amp;fields[rentals]=availability"</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">request</span><span class="p">({</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:get</span> <span class="p">})</span>
    <span class="n">json</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
    <span class="n">json</span><span class="o">[</span><span class="s2">"data"</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">rental</span><span class="o">|</span>
      <span class="n">update_rental_availability</span><span class="p">(</span><span class="n">rental</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">account_rentals_ids</span> <span class="o">-=</span> <span class="n">json</span><span class="o">[</span><span class="s2">"data"</span><span class="o">].</span><span class="n">pluck</span><span class="p">(</span><span class="s2">"id"</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_i</span><span class="p">)</span>
    <span class="k">break</span> <span class="k">if</span> <span class="n">page_number</span> <span class="o">&gt;=</span> <span class="n">json</span><span class="o">[</span><span class="s2">"meta"</span><span class="o">][</span><span class="s2">"pagination"</span><span class="o">][</span><span class="s2">"pages"</span><span class="o">].</span><span class="n">to_i</span>
    <span class="n">page_number</span><span class="o">++</span>
  <span class="k">end</span>
  <span class="n">disable_rentals</span><span class="p">(</span><span class="n">account_rentals_ids</span><span class="p">)</span>
<span class="k">end</span></code></pre>

<!-- Approach 2: Better code, but less effective -->
<pre><code class="language-ruby"><span class="n">token</span> <span class="o">=</span> <span class="s2">"&lt;YOUR_TOKEN&gt;"</span>
<span class="n">api_url</span> <span class="o">=</span> <span class="s2">"&lt;API_URL&gt;"</span>
<span class="n">media_type</span> <span class="o">=</span> <span class="s2">"application/vnd.api+json"</span>
<span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"User-Agent"</span> <span class="o">=&gt;</span> <span class="s2">"Api client"</span><span class="p">,</span>
    <span class="s2">"Accept"</span> <span class="o">=&gt;</span> <span class="n">media_type</span><span class="p">,</span>
    <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="n">media_type</span><span class="p">,</span>
    <span class="s2">"Authorization"</span> <span class="o">=&gt;</span> <span class="s2">"Bearer </span><span class="si">#{</span><span class="n">token</span><span class="si">}</span><span class="s2">"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="no">Rental</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">rental</span><span class="o">|</span>
  <span class="n">request</span> <span class="o">=</span> <span class="no">Excon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">URI</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="s2">"/api/ota/v1/rentals/</span><span class="si">#{</span><span class="n">rental</span><span class="o">.</span><span class="n">remote_id</span><span class="si">}</span><span class="s2">&amp;fields[rentals]=availability"</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

  <span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">request</span><span class="p">({</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:get</span> <span class="p">})</span>
  <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">json</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
    <span class="n">update_rental_availability</span><span class="p">(</span><span class="n">rental</span><span class="o">[</span><span class="s2">"data"</span><span class="o">][</span><span class="s2">"attributes"</span><span class="o">][</span><span class="s2">"availability"</span><span class="o">]</span><span class="p">)</span>
    <span class="n">make_rental_visible_if_was_hidden</span><span class="p">(</span><span class="n">rental</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="n">hide_rental</span><span class="p">(</span><span class="n">rental</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>

<h3 id="understanding-availabilities">Understanding availabilities</h3>

<p>The regular availability object consists of a map field, which contains statuses for the next 1096 days starting from the <code>start-date</code>. A status of ‘0’ indicates availability, while ‘1’ indicates unavailability.</p>

<pre><code class="language-ruby"><span class="p">{</span>
  <span class="s2">"map"</span><span class="p">:</span> <span class="s2">"0001111111111111111111111111100111111111111111110000000001111111111111111111111111111111111111111000001111111100111111100011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"</span><span class="p">,</span>
  <span class="s2">"start-date"</span><span class="p">:</span> <span class="s2">"2023-07-01"</span><span class="p">,</span>
  <span class="s2">"id"</span><span class="p">:</span> <span class="s2">"2"</span>
<span class="p">}</span></code></pre>

<p>Scope for ActiveRecord rental model could look like (assuming you are using Postgres and named <code>availability[map]</code> as <code>availability_map</code> and <code>availability[start_date]</code> as <code>availability_start_date</code>):</p>

<pre><code class="language-ruby">  <span class="n">scope</span> <span class="ss">:by_availabilities</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">unavailable_status</span> <span class="o">=</span> <span class="s1">'1'</span>
    <span class="n">start_point</span> <span class="o">=</span> <span class="s2">"DATE_PART('day', TIMESTAMP :date - availability_start_date)::integer+1"</span>
    <span class="n">availability_to_check_sql</span> <span class="o">=</span> <span class="s2">"SUBSTR(availability_map, </span><span class="si">#{</span><span class="n">start_point</span><span class="si">}</span><span class="s2">, :length_of_stay)"</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">availability_to_check_sql</span><span class="si">}</span><span class="s2"> NOT SIMILAR TO :check_statuses"</span><span class="p">,</span> <span class="ss">date</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span> <span class="ss">length_of_stay</span><span class="p">:</span> <span class="n">length</span><span class="p">,</span> <span class="ss">check_statuses</span><span class="p">:</span> <span class="n">unavailable_status</span><span class="p">)</span>
  <span class="p">}</span></code></pre>

<p><strong>SQL Example:</strong></p>

<pre><code class="language-sql"><span class="k">SELECT</span> <span class="n">r</span><span class="p">.</span><span class="n">id</span>
<span class="k">FROM</span> <span class="n">rentals</span> <span class="n">r</span>
<span class="k">WHERE</span>
  <span class="k">SUBSTRING</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">availability_map</span><span class="p">,</span>
            <span class="n">DATE_PART</span><span class="p">(</span><span class="s1">'day'</span><span class="p">,</span> <span class="k">TIMESTAMP</span> <span class="s1">'2023-07-01'</span> <span class="o">-</span> <span class="n">r</span><span class="p">.</span><span class="n">availability_start_date</span><span class="p">)::</span><span class="nb">integer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="mi">7</span><span class="p">)</span>
  <span class="k">NOT</span> <span class="k">SIMILAR</span> <span class="k">TO</span> <span class="s1">'1'</span><span class="p">;</span></code></pre>

<p><code>2023-07-01</code> - is a sample start date, <code>7</code> is a sample length of stay.</p>

<h3 id="fetching-rental-prices">Fetching Rental Prices</h3>

<p>Before we start, please read an article <a href="https://developers.bookingsync.com/guides/understanding-los-records/">Understanding LOS Records</a>. It explains what is LOS records and how it works.
We generate LOS records for the next 18 months, starting from yesterday.</p>

<blockquote>
  <p>Attention! <code>/los-records</code> is for debugging purposes only! Please don’t use it in production mode!</p>
</blockquote>

<p>To fetch rental prices, it is recommended to use <code>/api/ota/v1/los-record-export-urls</code> endpoint. This endpoint provides CSV files containing LOS records for rentals.
CSV files look like:</p>

<pre><code class="language-bash">id<span class="p">;</span>account_id<span class="p">;</span>rental_id<span class="p">;</span>currency<span class="p">;</span>min_occupancy<span class="p">;</span>max_occupancy<span class="p">;</span>kind<span class="p">;</span>day<span class="p">;</span>rates
<span class="m">45086517195</span><span class="p">;</span><span class="m">1</span><span class="p">;</span><span class="m">11</span><span class="p">;</span>EUR<span class="p">;</span><span class="m">1</span><span class="p">;</span><span class="m">4</span><span class="p">;</span>final_price<span class="p">;</span><span class="m">2023</span>-07-25<span class="p">;</span><span class="o">{</span><span class="m">0</span>.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,12501.45,13741.65,14981.85,16222.05,17462.25,18702.45,19942.65,21182.85,22423.05,23663.25,24903.45,26143.65,27383.85,28624.05,29864.25,31104.45,32344.65,33584.85,34825.05,36065.25,37305.45<span class="o">}</span>
<span class="m">46986331108</span><span class="p">;</span><span class="m">2</span><span class="p">;</span><span class="m">22</span><span class="p">;</span>EUR<span class="p">;</span><span class="m">1</span><span class="p">;</span><span class="m">1</span><span class="p">;</span>final_price<span class="p">;</span><span class="m">2023</span>-07-25<span class="p">;</span><span class="o">{</span><span class="m">0</span>.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,4422.6<span class="o">}</span>
<span class="m">47234184996</span><span class="p">;</span><span class="m">3</span><span class="p">;</span><span class="m">33</span><span class="p">;</span>EUR<span class="p">;</span><span class="m">1</span><span class="p">;</span><span class="m">1</span><span class="p">;</span>final_price<span class="p">;</span><span class="m">2023</span>-07-25<span class="p">;</span><span class="o">{</span><span class="m">0</span>.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,4422.6<span class="o">}</span>
<span class="m">47235754161</span><span class="p">;</span><span class="m">4</span><span class="p">;</span><span class="m">44</span><span class="p">;</span>EUR<span class="p">;</span><span class="m">1</span><span class="p">;</span><span class="m">1</span><span class="p">;</span>final_price<span class="p">;</span><span class="m">2023</span>-07-25<span class="p">;</span><span class="o">{</span><span class="m">0</span>.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,4422.6<span class="o">}</span>
<span class="m">47844857128</span><span class="p">;</span><span class="m">5</span><span class="p">;</span><span class="m">55</span><span class="p">;</span>EUR<span class="p">;</span><span class="m">1</span><span class="p">;</span><span class="m">4</span><span class="p">;</span>final_price<span class="p">;</span><span class="m">2023</span>-07-25<span class="p">;</span><span class="o">{</span><span class="m">0</span>.0,0.0,0.0,0.0,0.0,0.0,1096.2,1252.8,1409.4,1566.0,1722.6,1879.2,2035.8,2192.4,2349.0,2505.6,2662.2,2818.8,2975.4,3132.0,3288.6,3445.2,3601.8,3758.4,3915.0,4071.6,4228.2,4384.8,4541.4,4698.0<span class="o">}</span></code></pre>

<p>There are 3 kinds of LOS records (<a href="https://developers.bookingsync.com/reference/enums/#los-kinds">LOS kinds</a>):</p>

<ol>
  <li>
<strong>rental_price</strong> - Price for the rent only, after all discounts applied.</li>
  <li>
<strong>rental_price_before_special_offers</strong> - Price for the rent only, before special offers discounts being applied.</li>
  <li>
<strong>final_price</strong> - Price including all required fees and taxes.</li>
</ol>

<p>If you want to avoid price discrepancy, you have to use <strong>rental_price</strong> and apply all the fees and taxes on your side. Otherwise just use <strong>final_price</strong>.
Read more about <a href="/guides/difference-between-rental-price-and-final-price/">difference between rental price and final price</a>.</p>

<blockquote>
  <p>Recommendation: We update LOS files every 12 hours.</p>
</blockquote>

<h3 id="filtering-rentals-by-price">Filtering Rentals by Price</h3>

<p>To effectively filter rentals by price, consider creating a table for LOS records and importing prices from CSV files into this table. We suggest the following table structure:</p>

<pre><code class="language-sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">public</span><span class="p">.</span><span class="n">eur_los_records_v5</span> <span class="p">(</span>
    <span class="n">id</span> <span class="n">uuid</span> <span class="k">DEFAULT</span> <span class="k">public</span><span class="p">.</span><span class="n">gen_random_uuid</span><span class="p">()</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">synced_id</span> <span class="nb">bigint</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">day</span> <span class="nb">date</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">min_occupancy</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">max_occupancy</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">synced_rental_id</span> <span class="nb">bigint</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">rates_eur</span> <span class="nb">numeric</span><span class="p">[]</span> <span class="k">DEFAULT</span> <span class="s1">'{}'</span><span class="p">::</span><span class="nb">numeric</span><span class="p">[],</span>
    <span class="n">kind</span> <span class="nb">character</span> <span class="nb">varying</span><span class="p">,</span>
    <span class="n">synced_account_id</span> <span class="nb">bigint</span>
<span class="p">);</span></code></pre>

<p><strong>Sample ActiveRecord model for EUR LOS records</strong></p>

<pre><code class="language-ruby"><span class="k">class</span> <span class="nc">EurLosRecord</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># Helper scopes</span>
  <span class="n">scope</span> <span class="ss">:by_occupancy</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">occupancy</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">occupancy</span><span class="o">.</span><span class="n">to_i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">where</span><span class="p">(</span><span class="s2">"max_occupancy &gt;= ? AND min_occupancy &lt;= ?"</span><span class="p">,</span> <span class="n">occupancy</span><span class="p">,</span> <span class="n">occupancy</span><span class="p">)</span> <span class="p">:</span> <span class="n">by_default</span>
  <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:by_default</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">min_occupancy</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:by_date</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">day</span><span class="p">:</span> <span class="n">date</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:possible_to_stay_for</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s2">"rates_eur[:length] IS NOT NULL"</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:by_min_max_price_eur</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">min_price_eur</span><span class="p">,</span> <span class="n">max_price_eur</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">by_min_price_eur</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">min_price_eur</span><span class="p">)</span><span class="o">.</span><span class="n">by_max_price_eur</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">max_price_eur</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:by_min_price_eur</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">min_price_eur</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">min_price_eur</span><span class="o">.</span><span class="n">present?</span>
      <span class="n">where</span><span class="p">(</span><span class="s2">"rates_eur[:length] &gt;= :min_price_eur"</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="n">length</span><span class="p">,</span> <span class="ss">min_price_eur</span><span class="p">:</span> <span class="n">min_price_eur</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:by_max_price_eur</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">max_price_eur</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">max_price_eur</span><span class="o">.</span><span class="n">present?</span>
      <span class="n">where</span><span class="p">(</span><span class="s2">"rates_eur[:length] &lt;= :max_price_eur"</span><span class="p">,</span> <span class="ss">length</span><span class="p">:</span> <span class="n">length</span><span class="p">,</span> <span class="ss">max_price_eur</span><span class="p">:</span> <span class="n">max_price_eur</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="p">}</span>
  <span class="c1"># The main search scope</span>
  <span class="n">scope</span> <span class="ss">:by_occupancy_date_rate_price</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">occupancy</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">min_price_eur</span><span class="p">,</span> <span class="n">max_price_eur</span><span class="p">,</span> <span class="n">los_kind</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">scope</span> <span class="o">=</span> <span class="n">by_occupancy</span><span class="p">(</span><span class="n">occupancy</span><span class="p">)</span><span class="o">.</span><span class="n">by_date</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
    <span class="n">scope</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">by_kind</span><span class="p">(</span><span class="n">los_kind</span><span class="p">)</span> <span class="k">if</span> <span class="n">los_kind</span><span class="o">.</span><span class="n">present?</span>
    <span class="n">scope</span><span class="o">.</span><span class="n">possible_to_stay_for</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
      <span class="o">.</span><span class="n">by_min_max_price_eur</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">min_price_eur</span><span class="p">,</span> <span class="n">max_price_eur</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre>

<p>In controller you can use this scope to filter rentals:</p>

<pre><code class="language-ruby">  <span class="c1"># `by_availabilities` scope was described above</span>
  <span class="vi">@rentals</span> <span class="o">=</span> <span class="no">Rental</span><span class="o">.</span><span class="n">by_availabilities</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:date</span><span class="o">]</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:length</span><span class="o">]</span><span class="p">)</span>
  <span class="vi">@rentals</span> <span class="o">=</span> <span class="vi">@rentals</span>
    <span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:eur_los_records</span><span class="p">)</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="no">EurLosRecord</span><span class="o">.</span><span class="n">by_occupancy_date_rate_price</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:occupancy</span><span class="o">]</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:date</span><span class="o">]</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:length</span><span class="o">]</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:min_price</span><span class="o">]</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:max_price</span><span class="o">]</span><span class="p">))</span></code></pre>

        </div>
      </div>
    </div>
  </div>
</div>
    </div>
  </body>
</html>

