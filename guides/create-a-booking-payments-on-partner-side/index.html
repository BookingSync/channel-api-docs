<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>BookingSync API documentation</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/stylesheets/application.css">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
    <link rel="stylesheet" href="/highlight.css">
    <script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="/assets/javascripts/application.js"></script>

    <!-- you don't need to keep this, but it's cool for stats! -->
    <meta name="generator" content="nanoc 3.8.0">
  </head>
  <body class="flex-col">
    <div class="page-wrapper flex-1 flex-col">
      <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle sidebar-toggle collapsed" data-toggle="collapse" data-target="#navigation" aria-expanded="false">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">
              <img alt="BookingSync" src="/images/bookingsync.svg">
              <span>Developers</span>
            </a>
          </div>

          <div class="collapse navbar-collapse" id="navigation">
            <ul class="nav navbar-nav navbar-right">
              <li class="active">
                <a href="/guides/">Guides</a>
              </li>
              <li class="">
                <a href="https://demo.platforms.bookingsync.com/api-docs/index.html" target="_blank">API Reference</a>
              </li>
              <li><a href="https://www.smily.com" target="_blank">Smily.com</a></li>
              <li><a href="https://github.com/BookingSync/channel-api-docs" target="_blank"><i class="fa fa-github fa-fw fa-2x"></i></a></li>
            </ul>
          </div>
        </div>
      </nav>

<div class="container content">
  <div class="row">
    <div class="col-md-3 col-md-push-9">
      <div class="panel panel-default">
        <div class="list-group">
          <a class="list-group-item" href="/guides/api-overview">API overview</a>
          <a class="list-group-item" href="/guides/getting-started">Getting Started</a>
          <a class="list-group-item" href="/guides/accounts-synchronization">Accounts synchronization</a>
          <a class="list-group-item" href="/guides/rentals-synchronization">Rentals synchronization</a>
          <a class="list-group-item" href="/guides/create-a-booking-payments-on-partner-side">Create a booking (payments on partner side)</a>
          <a class="list-group-item" href="/guides/create-a-booking-with-smily-payment-gateway">Create a booking (payments on our side)</a>
          <a class="list-group-item" href="/guides/booking-cancelation">Booking cancelation</a>
        </div>
      </div>
    </div>
    <div class="col-md-9 col-md-pull-3">
      <div class="panel panel-default">
        <div class="panel-body guide-body">
          <h2 id="booking-and-payment-handling">Booking and Payment Handling</h2>

<ol id="markdown-toc">
  <li><a href="#preface" id="markdown-toc-preface">Preface</a></li>
  <li><a href="#quote-creation" id="markdown-toc-quote-creation">Quote creation</a></li>
  <li><a href="#booking-creation" id="markdown-toc-booking-creation">Booking creation</a></li>
  <li><a href="#payment-creation" id="markdown-toc-payment-creation">Payment creation</a></li>
</ol>

<h3 id="preface">Preface</h3>

<p>This document outlines the process of handling payments on the partner’s side. While we offer the option to use the Smily payment gateway, this guide focuses on managing payments directly through the partner’s infrastructure.</p>

<h3 id="quote-creation">Quote creation</h3>

<p>Before proceeding with booking creation, it’s necessary to confirm rental price and availability by generating a quote.</p>

<pre><code class="language-ruby"><span class="nb">require</span> <span class="s1">'excon'</span>

<span class="n">token</span> <span class="o">=</span> <span class="s2">"&lt;YOUR_TOKEN&gt;"</span>
<span class="n">api_url</span> <span class="o">=</span> <span class="s2">"&lt;API_URL&gt;"</span>
<span class="n">media_type</span> <span class="o">=</span> <span class="s2">"application/vnd.api+json"</span>
<span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"User-Agent"</span> <span class="o">=&gt;</span> <span class="s2">"Api client"</span><span class="p">,</span>
    <span class="s2">"Accept"</span> <span class="o">=&gt;</span> <span class="n">media_type</span><span class="p">,</span>
    <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="n">media_type</span><span class="p">,</span>
    <span class="s2">"Authorization"</span> <span class="o">=&gt;</span> <span class="s2">"Bearer </span><span class="si">#{</span><span class="n">token</span><span class="si">}</span><span class="s2">"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">request</span> <span class="o">=</span> <span class="no">Excon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">URI</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="s2">"/api/ota/v1/quotes"</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="ss">attributes</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"start-at"</span><span class="p">:</span> <span class="s2">"2023-08-04"</span><span class="p">,</span>
      <span class="s2">"end-at"</span><span class="p">:</span> <span class="s2">"2023-08-11"</span><span class="p">,</span>
      <span class="s2">"adults"</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
      <span class="s2">"children"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">"rental-id"</span><span class="p">:</span> <span class="mi">428</span>
    <span class="p">},</span>
    <span class="ss">type</span><span class="p">:</span> <span class="s2">"quotes"</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">request</span><span class="p">({</span>
  <span class="nb">method</span><span class="p">:</span> <span class="ss">:post</span><span class="p">,</span>
  <span class="ss">body</span><span class="p">:</span> <span class="n">payload</span><span class="o">.</span><span class="n">to_json</span>
<span class="p">})</span>

<span class="n">json</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
<span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">201</span>
  <span class="n">price</span> <span class="o">=</span> <span class="n">json</span><span class="o">[</span><span class="s2">"data"</span><span class="o">][</span><span class="s2">"attributes"</span><span class="o">][</span><span class="s2">"final-price"</span><span class="o">]</span>
  <span class="n">booking_url</span> <span class="o">=</span> <span class="n">json</span><span class="o">[</span><span class="s2">"data"</span><span class="o">][</span><span class="s2">"attributes"</span><span class="o">][</span><span class="s2">"booking-url"</span><span class="o">]</span>
  <span class="c1"># Proceed to booking creation via API or redirect user to booking_url</span>
<span class="k">else</span>
  <span class="n">handle_errors</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
<span class="k">end</span></code></pre>

<h3 id="booking-creation">Booking creation</h3>

<p>Once a successful quote is obtained, initiate a booking request by providing client details, rental information, and pricing.</p>

<blockquote>
  <p>Note: Ensure that the provided price matches or higher than <code>final-price</code> from the quote.</p>
</blockquote>

<pre><code class="language-ruby"><span class="n">token</span> <span class="o">=</span> <span class="s2">"&lt;YOUR_TOKEN&gt;"</span>
<span class="n">api_url</span> <span class="o">=</span> <span class="s2">"&lt;API_URL&gt;"</span>
<span class="n">media_type</span> <span class="o">=</span> <span class="s2">"application/vnd.api+json"</span>
<span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"User-Agent"</span> <span class="o">=&gt;</span> <span class="s2">"Api client"</span><span class="p">,</span>
    <span class="s2">"Accept"</span> <span class="o">=&gt;</span> <span class="n">media_type</span><span class="p">,</span>
    <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="n">media_type</span><span class="p">,</span>
    <span class="s2">"Authorization"</span> <span class="o">=&gt;</span> <span class="s2">"Bearer </span><span class="si">#{</span><span class="n">token</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
    <span class="s2">"Idempotency-Key"</span> <span class="o">=&gt;</span> <span class="n">get_order_uuid</span> <span class="c1"># Use a unique ID for idempotency</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">request</span> <span class="o">=</span> <span class="no">Excon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">URI</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="s2">"/api/ota/v1/bookings"</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="ss">attributes</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"start-at"</span><span class="p">:</span> <span class="s2">"2020-09-04T16:00:00.000Z"</span><span class="p">,</span> <span class="c1"># "2020-09-04" works too</span>
      <span class="s2">"end-at"</span><span class="p">:</span> <span class="s2">"2020-09-11T10:00:00.000Z"</span><span class="p">,</span> <span class="c1"># "2020-09-11" works too</span>
      <span class="s2">"adults"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s2">"children"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">"final-price"</span><span class="p">:</span> <span class="s2">"176.0"</span><span class="p">,</span>
      <span class="s2">"currency"</span><span class="p">:</span> <span class="s2">"EUR"</span><span class="p">,</span>
      <span class="s2">"rental-id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">"client-first-name"</span><span class="p">:</span> <span class="s2">"Rich"</span><span class="p">,</span>
      <span class="s2">"client-last-name"</span><span class="p">:</span> <span class="s2">"Piana"</span><span class="p">,</span>
      <span class="s2">"client-email"</span><span class="p">:</span> <span class="s2">"rich@piana.com"</span><span class="p">,</span>
      <span class="s2">"client-phone-number"</span><span class="p">:</span> <span class="s2">"123123123"</span><span class="p">,</span>
      <span class="s2">"client-country-code"</span><span class="p">:</span> <span class="s2">"US"</span>
    <span class="p">},</span>
    <span class="ss">type</span><span class="p">:</span> <span class="s2">"bookings"</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">request</span><span class="p">({</span>
  <span class="nb">method</span><span class="p">:</span> <span class="ss">:post</span><span class="p">,</span>
  <span class="ss">body</span><span class="p">:</span> <span class="n">payload</span><span class="o">.</span><span class="n">to_json</span>
<span class="p">})</span>

<span class="n">json</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
<span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">201</span>
  <span class="n">booking_id</span> <span class="o">=</span> <span class="n">json</span><span class="o">[</span><span class="s2">"data"</span><span class="o">][</span><span class="s2">"id"</span><span class="o">]</span>
  <span class="c1"># Save the booking ID for future reference</span>
<span class="k">else</span>
  <span class="n">handle_errors</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
<span class="k">end</span></code></pre>

<blockquote>
  <p><strong>Note:</strong> If a created booking includes the not null <code>tentative-expires-at</code> field, it may be automatically canceled if no payment is made. Therefore, it’s essential to proceed with payment creation.</p>
</blockquote>

<p>We strongly recommend setting the <code>Idempotency-Key</code> header to prevent duplicate creations. Generate a UUID for each order and use it as the <code>Idempotency-Key</code>.</p>

<p>For example, if you attempt to create a booking but encounter a network connection issue or another error that prevents you from receiving a response, you can safely retry your request. This is possible because, for a specific key, each successful response will be cached for a 6 hours.</p>

<h3 id="payment-creation">Payment creation</h3>

<p>Once payment for the booking is processed, notify us to prevent booking cancellation.</p>

<pre><code class="language-ruby"><span class="n">token</span> <span class="o">=</span> <span class="s2">"&lt;YOUR_TOKEN&gt;"</span>
<span class="n">api_url</span> <span class="o">=</span> <span class="s2">"&lt;API_URL&gt;"</span>
<span class="n">media_type</span> <span class="o">=</span> <span class="s2">"application/vnd.api+json"</span>
<span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"User-Agent"</span> <span class="o">=&gt;</span> <span class="s2">"Api client"</span><span class="p">,</span>
    <span class="s2">"Accept"</span> <span class="o">=&gt;</span> <span class="n">media_type</span><span class="p">,</span>
    <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="n">media_type</span><span class="p">,</span>
    <span class="s2">"Authorization"</span> <span class="o">=&gt;</span> <span class="s2">"Bearer </span><span class="si">#{</span><span class="n">token</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
    <span class="s2">"Idempotency-Key"</span> <span class="o">=&gt;</span> <span class="n">get_payment_uuid</span> <span class="c1"># Use a unique ID for idempotency</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">request</span> <span class="o">=</span> <span class="no">Excon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">URI</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="s2">"/api/ota/v1/payments"</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="ss">attributes</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"amount"</span><span class="p">:</span> <span class="s2">"100.0"</span><span class="p">,</span>
      <span class="s2">"currency"</span><span class="p">:</span> <span class="s2">"EUR"</span><span class="p">,</span>
      <span class="s2">"paid-at"</span><span class="p">:</span> <span class="s2">"2020-09-10T05:30:18.321Z"</span><span class="p">,</span>
      <span class="s2">"kind"</span><span class="p">:</span> <span class="s2">"credit-card"</span><span class="p">,</span>
      <span class="s2">"booking-id"</span><span class="p">:</span> <span class="n">booking_id</span>
    <span class="p">},</span>
    <span class="ss">type</span><span class="p">:</span> <span class="s2">"payments"</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">request</span><span class="p">({</span>
  <span class="nb">method</span><span class="p">:</span> <span class="ss">:post</span><span class="p">,</span>
  <span class="ss">body</span><span class="p">:</span> <span class="n">payload</span><span class="o">.</span><span class="n">to_json</span>
<span class="p">})</span>

<span class="n">json</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
<span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">201</span>
  <span class="n">booking_id</span> <span class="o">=</span> <span class="n">json</span><span class="o">[</span><span class="s2">"data"</span><span class="o">][</span><span class="s2">"id"</span><span class="o">]</span>
  <span class="c1"># Save the payment ID for reference</span>
<span class="k">else</span>
  <span class="n">handle_errors</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
<span class="k">end</span></code></pre>

<blockquote>
  <p><strong>Note:</strong> Payments endpoint also support <code>Idempotency-Key</code> header. To ensure idempotent writes and frictionless integration, it is highly recommended to provide <code>Idempotency-Key</code> header. For a given key, every success response will be cached for 6 hours. Thanks to that, you can safely retry write operation.</p>
</blockquote>

        </div>
      </div>
    </div>
  </div>
</div>
    </div>
  </body>
</html>

